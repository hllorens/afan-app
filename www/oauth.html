<!DOCTYPE html>

<head>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
	</script>
	<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
	</script>
</head>
<body>
<!-- GOOGLE PLUS SIGN IN-->        


<div id="signinButton">
  <span class="g-signin"
    data-scope="openid email" 
    data-clientid="125860785862-s07kh0j5tpb2drjkeqsifldn39krhh60.apps.googleusercontent.com"
    data-redirecturi="postmessage"
    data-accesstype="offline"
    data-cookiepolicy="single_host_origin"
    data-callback="signInCallback"
	> 
  </span><!-- scope: openid email https://www.googleapis.com/auth/plus.login --> <!-- delete data-approvalprompt="force" when debugged -->
</div>
<a href="#" onclick="gdisconnect();">force disconnect</a>
<!--<a href="#" onclick="show_secret()">show secret</a>-->
<div id="result"></div>


<script>
var session_state="unset";

/*function show_secret(){
	$.ajax({
		type: 'POST',
		url: 'backend/ajaxdb.php?action=show_secret',
		success: function(result) {
			if (result) {
				console.log(result);
				$('#result').html('RESULT</br>'+ result + '</br>Redirecting...');
			} else {
				$('#result').html('Failed to show secret.</br>Result:'+ result);
			}
		}
	}); 
	return false;
}*/

function signInCallback(authResult) {
	//console.log(authResult);
	if (authResult['code']) {
		$('#signinButton').attr('style', 'display: none'); // hide button
		// Send one-time-code to server, if responds -> success
		$.ajax({
			type: 'POST',
			url: 'backend/ajaxdb.php?action=gconnect&state='+session_state+'&code='+authResult['code'],
			processData: false,
			data: authResult['code'],
			contentType: 'application/octet-stream; charset=utf-8',
			success: function(result) {
				if (result) {
					console.log(result);
					$('#result').html('RESULT</br>'+ result + ' (<a href="#" onclick="gdisconnect();">disconnect</a>)</br>Redirecting...');
					/*setTimeout(function() {
					window.location.href = "/restaurant";
					}, 4000);*/
				} else if (authResult['error']) {
					$('#signinButton').attr('style', 'display: block'); // hide button
					console.log('There was an error: ' + authResult['error']);
				} else {
					$('#signinButton').attr('style', 'display: block'); // hide button
					$('#result').html('Failed to make a server-side call. Check your configuration and console.</br>Result:'+ result);
				}
			}
		}); 
	}
}

function gdisconnect(){
	$.ajax({
		type: 'POST',
		url: 'backend/ajaxdb.php?action=gdisconnect',
		success: function(result) {
			if (result) {
				$('#signinButton').attr('style', 'display: block'); // hide button
				console.log(result);
				$('#result').html('RESULT</br>'+ result + '</br>Redirecting...');
				/*setTimeout(function() {
				window.location.href = "/restaurant";
				}, 4000);*/
			} else {
				$('#result').html('Failed to disconnect.</br>Result:'+ result);
			}
		}
	}); 
	return false;
}

function ajax_request(url, callback, type, method) {
	if(typeof(method)==="undefined") method = "GET";
	if(typeof(type)==="undefined") type = "text";
	var xhr=new XMLHttpRequest();
	xhr.responsetype=type;
	xhr.onreadystatechange = function(){
		if (xhr.readyState ===4) { // XMLHttpRequest.DONE value
			if (xhr.status === 200) {
	            if(type=="json"){
	                callback(JSON.parse(xhr.responseText));
				}else{
	                callback(xhr.responseText);
				}
			} else {
				alert("AJAX ERROR: "+xhr.status);
			}
		}
	}
	xhr.open(method, url, true);
	xhr.send()
}

ajax_request('backend/ajaxdb.php?action=gen_session_state',function(text) {
	session_state=text;
	console.log(session_state);
});
  
  
</script>



<!--END GOOGLE PLUS SIGN IN -->
</body>
</html>