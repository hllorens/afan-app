<!DOCTYPE html>

<head>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script src="https://apis.google.com/js/client:platform.js?onload=start" async defer>
	</script>
</head>
<body>
<!-- GOOGLE PLUS SIGN IN-->        


<div id="signinButton">
  <span class="g-signin"
    data-scope="openid email" 
    data-clientid="125860785862-s07kh0j5tpb2drjkeqsifldn39krhh60.apps.googleusercontent.com"
    data-redirecturi="postmessage"
    data-accesstype="offline"
    data-cookiepolicy="single_host_origin"
    data-callback="signInCallback"
	> 
  </span><!-- scope: openid email https://www.googleapis.com/auth/plus.login --> <!-- delete data-approvalprompt="force" when debugged, use another URI (e.g., server to avoid geting back to client?) -->
</div>
<a href="#" onclick="gdisconnect();">force disconnect</a>
<!--<a href="#" onclick="show_secret()">show secret</a>-->
<div id="result"></div>


<script>
var session_state="unset";
/*
// TODO try if this works in a phonegap after it is ingetrated in the app
//http://stackoverflow.com/questions/23930744/how-to-use-google-login-api-with-cordova-phonegap
 var googleapi = {
        authorize: function(options) {
            var deferred = $.Deferred();

            //Build the OAuth consent page URL
            var authUrl = 'https://accounts.google.com/o/oauth2/auth?' + $.param({
                client_id: 'the id...',
                redirect_uri: 'http://localhost',
                response_type: 'code',
                scope: 'openid email'
            });

            //Open the OAuth consent page in the InAppBrowser
            var authWindow = window.open(authUrl, '_blank', 'location=no,toolbar=no');

            //The recommendation is to use the redirect_uri "urn:ietf:wg:oauth:2.0:oob"
            //which sets the authorization code in the browser's title. However, we can't
            //access the title of the InAppBrowser.
            //
            //Instead, we pass a bogus redirect_uri of "http://localhost", which means the
            //authorization code will get set in the url. We can access the url in the
            //loadstart and loadstop events. So if we bind the loadstart event, we can
            //find the authorization code and close the InAppBrowser after the user
            //has granted us access to their data.
            $(authWindow).on('loadstart', function(e) {
                var url = e.originalEvent.url;
                var code = /\?code=(.+)$/.exec(url);
                var error = /\?error=(.+)$/.exec(url);

                if (code || error) {
                    //Always close the browser when match is found
                    authWindow.close();
                }

                if (code) {
                    // run the callback as in the normal version
                } else if (error) {
                    //The user denied access to the app
                    deferred.reject({
                        error: error[1]
                    });
                }
            });

            return deferred.promise();
        }

    };

*/


/*function show_secret(){
	$.ajax({
		type: 'POST',
		url: 'backend/ajaxdb.php?action=show_secret',
		success: function(result) {
			if (result) {
				console.log(result);
				$('#result').html('RESULT</br>'+ result + '</br>Redirecting...');
			} else {
				$('#result').html('Failed to show secret.</br>Result:'+ result);
			}
		}
	}); 
	return false;
}*/

function signInCallback(authResult) {
	//console.log(authResult);
	if (authResult['code']) {
		$('#signinButton').attr('style', 'display: none'); // hide button
		// Send one-time-code to server, if responds -> success
		console.log(authResult);
		$.ajax({
			type: 'POST',
			url: 'backend/ajaxdb.php?action=gconnect&state='+session_state+'&code='+authResult['code'],
			processData: false,
			data: authResult['code'],
			contentType: 'application/octet-stream; charset=utf-8',
			success: function(result) {
				if (result) {
					//console.log(result); debug
					$('#result').html('RESULT</br>'+ result + ' (<a href="#" onclick="gdisconnect();">disconnect</a>)</br>Redirecting...');
					/*setTimeout(function() {
					window.location.href = "/restaurant";
					}, 4000);*/
				} else if (authResult['error']) {
					$('#signinButton').attr('style', 'display: block'); // hide button
					console.log('There was an error: ' + authResult['error']);
				} else {
					$('#signinButton').attr('style', 'display: block'); // hide button
					$('#result').html('Failed to make a server-side call. Check your configuration and console.</br>Result:'+ result);
				}
			}
		}); 
	}
}

function gdisconnect(){
	$.ajax({
		type: 'POST',
		url: 'backend/ajaxdb.php?action=gdisconnect',
		success: function(result) {
			if (result) {
				$('#signinButton').attr('style', 'display: block'); // hide button
				console.log(result);
				$('#result').html('RESULT</br>'+ result + '</br>Redirecting...');
				/*setTimeout(function() {
				window.location.href = "/restaurant";
				}, 4000);*/
			} else {
				$('#result').html('Failed to disconnect.</br>Result:'+ result);
			}
		}
	}); 
	return false;
}

function ajax_request(url, callback, type, method) {
	if(typeof(method)==="undefined") method = "GET";
	if(typeof(type)==="undefined") type = "text";
	var xhr=new XMLHttpRequest();
	xhr.responsetype=type;
	xhr.onreadystatechange = function(){
		if (xhr.readyState ===4) { // XMLHttpRequest.DONE value
			if (xhr.status === 200) {
	            if(type=="json"){
	                callback(JSON.parse(xhr.responseText));
				}else{
	                callback(xhr.responseText);
				}
			} else {
				alert("AJAX ERROR: "+xhr.status);
			}
		}
	}
	xhr.open(method, url, true);
	xhr.send()
}

ajax_request('backend/ajaxdb.php?action=gen_session_state',function(text) {
	session_state=text;
	console.log(session_state);
});
  
  
</script>



<!--END GOOGLE PLUS SIGN IN -->
</body>
</html>